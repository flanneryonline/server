#!/usr/bin/env bash

exec 2> >(logger -s -t $(basename $0))

export DEBIAN_FRONTEND=noninteractive

use_sudo=
if [ $UID -ne 0 ]; then
    use_sudo="sudo"
fi

SERVER_INSTALL=${SERVER_INSTALL:-/opt/server}
. "$SERVER_INSTALL/environment"

$use_sudo apt-get update -qq
$use_sudo apt-get upgrade -qq --no-install-recommends
$use_sudo apt-get dist-upgrade -qq --no-install-recommends
$use_sudo apt-get autoremove -qq

#server config update
if [ ! -d "$SERVER_INSTALL" ]
then
    $use_sudo git clone "$SERVER_GIT_LOCATION" "$SERVER_INSTALL"
fi
pushd "$SERVER_INSTALL" >/dev/null
$use_sudo git rev-parse --git-dir >/dev/null 2>&1
$use_sudo git remote update >/dev/null
local_rev=$(git rev-parse main)
server_rev=$(git rev-parse origin/main)
if [ "$local_rev" != "$server_rev" ]
then
    $use_sudo git reset --hard origin/main >/dev/null
fi
popd >/dev/null

chmod +x $SERVER_INSTALL/bin/*
chmod +x $SERVER_INSTALL/bin/service-scripts/*
chmod +x $SERVER_INSTALL/onetimesetup/*

cat $SECRETS_LOCATION >> $SERVER_INSTALL/environment

systemctl daemon-reload

$SERVER_INSTALL/bin/sdupdate -a

exit 0